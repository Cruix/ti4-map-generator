<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/> 
<html>
<head>
	<link rel="stylesheet" type="text/css" href="./res/style.css">
	<link rel="icon" type="image/png" href="res/favicon.png">
	<script src="./res/jquery.min.js"></script>
</head>

<body>
	<h1>TWILIGHT IMPERIUM IV BALANCED MAP GENERATOR</h1>
	<div id="text_div" style="float:left">
		<form id="generate_form" action="./cgi-bin/ti4-map-generator-cgi.py">
			Number of Players:
			<select id="n_players" name="n_players">
				<option value=6>6</option>
				<option value=5>5</option>
				<option value=4>4</option>
				<option value=3>3</option>
			</select>
			<br>

			<label><input type="radio" id="race_selection_method" name="race_selection_method" value="dummy" checked> Blank Home Systems</label>
			<label><input type="radio" id="race_selection_method" name="race_selection_method" value="random"> Random Races</label>
			<label><input type="radio" id="race_selection_method" name="race_selection_method" value="chosen"> Select Races</label><br>
			<div id="race_select_div"></div>

			Display in:
			<label><input type="radio" id="bw" name="bw" value="false" checked>Colour</label>
			<label><input type="radio" id="bw" name="bw" value="true"> Black and White</label><br>

			Optimization Settings:<br>
			<label><input type="CHECKBOX" id="creuss_gets_wormhole" name="creuss_gets_wormhole" checked>Give the Ghosts of Creuss a Wormhole</label><br>
			<label><input type="CHECKBOX" id="muaat_gets_supernova" name="muaat_gets_supernova" checked>Give the Embers of Muaat a Supernova</label><br>
			<label><input type="CHECKBOX" id="winnu_clear_path_to_mecatol" name="winnu_clear_path_to_mecatol" checked>Make sure the Winnu have a clear path to Mecatol Rex</label><br>


			<input type="submit" value="Generate">
		</form>
	</div>
			
	<div id="galaxy_image_div" style="float:left;"></div>

	<script text/javascript>
		$("#document").ready(function() {

			function create_race_selection_boxes() {
				// Create race select boxes
				var races = [
					{"number": 1, "race": "The Federation of Sol"},
					{"number": 2, "race": "The Mentak Coalition"},
					{"number": 3, "race": "The Brotherhood of Yin"},
					{"number": 4, "race": "The Embers of Muaat"},
					{"number": 5, "race": "The Aborec"},
					{"number": 6, "race": "The L1Z1X Mindnet"},
					{"number": 7, "race": "The Winnu"},
					{"number": 8, "race": "The Nekro Virus"},
					{"number": 9, "race": "The Naalu Collective"},
					{"number": 10, "race": "The Baroney of Letnev"},
					{"number": 11, "race": "The Clan of Saar"},
					{"number": 12, "race": "The Universities of Jol-Nar"},
					{"number": 13, "race": "Sardakk'Norr"},
					{"number": 14, "race": "The Xxcha Kingdom"},
					{"number": 15, "race": "The Yssaril Tribes"},
					{"number": 16, "race": "The Emerates of Hacan"},
					{"number": 17, "race": "The Ghosts of Creuss"},
					];
				$('#race_select_div').empty();
				if ($("#race_selection_method:checked").val() != "chosen") {
					return;
				}
				var i;
				for (i = 0; i < $("#n_players").val(); i++) {
					var race_select = $("<select>").appendTo($('#race_select_div'));
					$(races).each(function() {
						race_select.append($('<option>').attr('value', this.number).text(this.race));
					});
					race_select.attr('id', "race" + i);
					race_select.val(i+1);
					$("<br>").appendTo($('#race_select_div'));
				}
			}

			function get_selected_races() {
				var races = "";
				for (i = 0; i < $("#n_players").val(); i++) {
					races += $("#race" + i).val() + " ";
				}
				return races;
			}

			function hasDuplicates(array) {
				    return (new Set(array)).size !== array.length;
			}

			function race_duplicates() {
				if ($("#race_selection_method:checked").val() != "chosen") {
					return false;
				}

				var races = [];
				for (i = 0; i < $("#n_players").val(); i++) {
					races.push($("#race" + i).val());
				}
				return hasDuplicates(races);
			}


			create_race_selection_boxes();
			$('#n_players').change(create_race_selection_boxes);
			$('input[name=race_selection_method]').click(create_race_selection_boxes);

			$("#generate_form").submit(function(event) {
				event.preventDefault();
			
				if (race_duplicates()) {
					alert("Cannot have duplicate races");
					return;
				}

				var loading = $('<img src="./res/loading.gif">');
				$("#galaxy_image_div").html(loading);

				var get = $.get("./cgi-bin/ti4-map-generator-cgi.py", 
					{
						bw: $("#bw:checked").val(),
						race_selection_method: $("#race_selection_method:checked").val(),
						n_players: $("#n_players").val(),
						races: get_selected_races(),
						creuss_gets_wormhole: $("#creuss_gets_wormhole").prop("checked"),
						muaat_gets_supernova: $("#muaat_gets_supernova").prop("checked"),
						winnu_clear_path_to_mecatol: $("#winnu_clear_path_to_mecatol").prop("checked")
					});
				get.done(function(data) {
					$("#galaxy_image_div").html(data);
				});
			});
		});

	</script>
</body>
</html>
